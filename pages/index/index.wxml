<view class="page">
  <!-- å¤´éƒ¨æ ‡é¢˜ -->
  <view class="header">
    <view class="title">å¥åº·é¥®é£ŸåŠ©æ‰‹ï¼ˆAIç‰ˆï¼‰</view>
    <view class="subtitle">è®©AIä¸ºæ‚¨ç”Ÿæˆç¾å‘³èœè°±</view>
    <!-- ç”¨æˆ·é™åˆ¶ä¿¡æ¯ -->
    <view class="user-limits" wx:if="{{isLoggedIn && userLimits}}">
      <text class="limits-text">ä»Šæ—¥å‰©ä½™: {{userLimits.daily_generation_limit - userLimits.daily_generation_count}}/{{userLimits.daily_generation_limit}} æ¬¡ | æ”¶è—: {{userLimits.total_favorites_count}}/{{userLimits.total_favorites_limit}}</text>
    </view>
    <view class="user-limits" wx:if="{{!isLoggedIn}}">
      <text class="limits-text">è¯·ç™»å½•åä½¿ç”¨</text>
    </view>
  </view>

  <!-- ä¸»å†…å®¹æ•´ä½“å¡ç‰‡ï¼ˆåœ†è§’ä¸Šæ²¿ï¼‰ -->
  <view class="main-sheet">
  <!-- é¡¶éƒ¨æ ‡ç­¾é¡µ -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 0 ? 'active' : ''}}" bindtap="onTabChange" data-index="0">é£Ÿæ</view>
    <view class="tab-item {{activeTab === 1 ? 'active' : ''}}" bindtap="onTabChange" data-index="1">èœå“ç±»å‹</view>
    <view class="tab-item {{activeTab === 2 ? 'active' : ''}}" bindtap="onTabChange" data-index="2">èœç³»é£æ ¼</view>
    <view class="tab-item {{activeTab === 3 ? 'active' : ''}}" bindtap="onTabChange" data-index="3">çƒ¹é¥ªæ–¹å¼</view>
  </view>

  <!-- é€‰æ‹©åŒºåŸŸå¡ç‰‡ -->
  <view class="card">
    <view class="card-content">
      <!-- é£Ÿæå¤šé€‰ï¼Œæ¨ªå‘tabåˆ‡æ¢å¤§ç±» -->
      <view wx:if="{{activeTab === 0}}">
        <view class="form-label">é€‰æ‹©é£Ÿæï¼ˆå¯ä¸é€‰ï¼Œéšæœºç”Ÿæˆèœè°±ï¼‰</view>
        <view class="ingredient-tabs">
          <block wx:for="{{ingredientCategoryTabs}}" wx:key="index">
            <view class="ingredient-tab {{activeIngredientCategoryTab == index ? 'active' : ''}}"
                  data-index="{{index}}"
                  bindtap="onIngredientCategoryTabChange">
              {{item}}
            </view>
          </block>
        </view>
        <view class="category-group">
          <view class="category-title">{{categorizedIngredients[activeIngredientCategoryTab].categoryName}}</view>
          <view class="multi-select-list">
            <block wx:for="{{categorizedIngredients[activeIngredientCategoryTab].ingredients}}" wx:key="name">
              <view class="multi-select-item {{item.selected ? 'selected' : ''}}"
                    bindtap="onIngredientTagTap"
                    data-category-index="{{activeIngredientCategoryTab}}"
                    data-ingredient-index="{{index}}">
                {{item.name}}
              </view>
            </block>
            <view class="add-custom-btn" bindtap="onShowAddCustomInput" data-type="ingredient">+ æ–°å¢</view>
          </view>
        </view>
        <!-- è‡ªå®šä¹‰é£Ÿæè¾“å…¥æ¡†å¼¹çª— -->
        <view wx:if="{{showAddCustomInput && addCustomType === 'ingredient'}}" class="add-custom-modal">
          <view class="add-custom-modal-content">
            <input class="add-custom-input" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰é£Ÿæ" value="{{addCustomValue}}" bindinput="onAddCustomInput" />
            <button class="add-custom-confirm" bindtap="onAddCustomConfirm">æ·»åŠ </button>
            <button class="add-custom-cancel" bindtap="onAddCustomCancel">å–æ¶ˆ</button>
          </view>
        </view>
      </view>
      <!-- æ–°å¢ï¼šå¤§ç±»å•é€‰ -->
      <view wx:if="{{activeTab === 1}}">
        <view class="form-label">é€‰æ‹©å¤§ç±»ï¼ˆå¯ä¸é€‰ï¼‰</view>
        <view class="single-select-list">
          <block wx:for="{{dishTypeNames}}" wx:key="index">
            <view class="single-select-item {{selectedDishTypeIndex === index ? 'selected' : ''}}"
                  bindtap="onDishTypeTagTap"
                  data-index="{{index}}">
              {{item}}
            </view>
          </block>
          <view class="add-custom-btn" bindtap="onShowAddCustomInput" data-type="dishType">+ æ–°å¢</view>
        </view>
        <!-- è‡ªå®šä¹‰ç±»å‹è¾“å…¥æ¡†å¼¹çª— -->
        <view wx:if="{{showAddCustomInput && addCustomType === 'dishType'}}" class="add-custom-modal">
          <view class="add-custom-modal-content">
            <input class="add-custom-input" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ç±»å‹" value="{{addCustomValue}}" bindinput="onAddCustomInput" />
            <button class="add-custom-confirm" bindtap="onAddCustomConfirm">æ·»åŠ </button>
            <button class="add-custom-cancel" bindtap="onAddCustomCancel">å–æ¶ˆ</button>
          </view>
        </view>
      </view>
      <!-- èœç³»/ç§ç±»å•é€‰ -->
      <view wx:if="{{activeTab === 2}}">
        <view class="form-label">é€‰æ‹©èœç³»ï¼ˆå¯ä¸é€‰ï¼Œé»˜è®¤ä¸ºå®¶å¸¸èœï¼‰</view>
        <view class="single-select-list">
          <block wx:for="{{typeNames}}" wx:key="index">
            <view class="single-select-item {{selectedTypeIndex === index ? 'selected' : ''}}"
                  bindtap="onTypeTagTap"
                  data-index="{{index}}">
              {{item}}
            </view>
          </block>
          <view class="add-custom-btn" bindtap="onShowAddCustomInput" data-type="type">+ æ–°å¢</view>
        </view>
        <!-- è‡ªå®šä¹‰èœç³»è¾“å…¥æ¡†å¼¹çª— -->
        <view wx:if="{{showAddCustomInput && addCustomType === 'type'}}" class="add-custom-modal">
          <view class="add-custom-modal-content">
            <input class="add-custom-input" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰èœç³»" value="{{addCustomValue}}" bindinput="onAddCustomInput" />
            <button class="add-custom-confirm" bindtap="onAddCustomConfirm">æ·»åŠ </button>
            <button class="add-custom-cancel" bindtap="onAddCustomCancel">å–æ¶ˆ</button>
          </view>
        </view>
      </view>
      <!-- çƒ¹é¥ªæ–¹å¼å•é€‰ -->
      <view wx:if="{{activeTab === 3}}">
        <view class="form-label">é€‰æ‹©çƒ¹é¥ªæ–¹å¼ï¼ˆå¯ä¸é€‰ï¼‰</view>
        <view class="single-select-list">
          <block wx:for="{{methodNames}}" wx:key="index">
            <view class="single-select-item {{selectedMethodIndex === index ? 'selected' : ''}}"
                  bindtap="onMethodTagTap"
                  data-index="{{index}}">
              {{item}}
            </view>
          </block>
          <view class="add-custom-btn" bindtap="onShowAddCustomInput" data-type="method">+ æ–°å¢</view>
        </view>
        <!-- è‡ªå®šä¹‰æ–¹å¼è¾“å…¥æ¡†å¼¹çª— -->
        <view wx:if="{{showAddCustomInput && addCustomType === 'method'}}" class="add-custom-modal">
          <view class="add-custom-modal-content">
            <input class="add-custom-input" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ–¹å¼" value="{{addCustomValue}}" bindinput="onAddCustomInput" />
            <button class="add-custom-confirm" bindtap="onAddCustomConfirm">æ·»åŠ </button>
            <button class="add-custom-cancel" bindtap="onAddCustomCancel">å–æ¶ˆ</button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å·²é€‰å†…å®¹å±•ç¤º -->
  <view wx:if="{{selectedIngredientNames.length > 0 || selectedDishTypeName || selectedTypeName || selectedMethodName}}" class="selected-ingredients-bar">
    <scroll-view scroll-x="true" class="selected-ingredients-list">
      <block wx:if="{{selectedIngredientNames.length > 0}}">
        <view class="selected-ingredients-label">å·²é€‰é£Ÿæï¼š</view>
        <block wx:for="{{selectedIngredientNames}}" wx:key="name">
          <view class="selected-ingredient-tag">{{item}}</view>
        </block>
      </block>
      <block wx:if="{{selectedDishTypeName}}">
        <view class="selected-ingredients-label">ç±»å‹ï¼š</view>
        <view class="selected-ingredient-tag">{{selectedDishTypeName}}</view>
      </block>
      <block wx:if="{{selectedTypeName}}">
        <view class="selected-ingredients-label">èœç³»ï¼š</view>
        <view class="selected-ingredient-tag">{{selectedTypeName}}</view>
      </block>
      <block wx:if="{{selectedMethodName}}">
        <view class="selected-ingredients-label">æ–¹å¼ï¼š</view>
        <view class="selected-ingredient-tag">{{selectedMethodName}}</view>
      </block>
    </scroll-view>
    <view class="clear-selected-btn" bindtap="onClearAllSelections">ğŸ—‘ï¸</view>
  </view>

  <!-- åŠŸèƒ½æŒ‰é’®åŒºåŸŸ -->
  <view class="function-buttons">
    <button class="btn-primary big" bindtap="onGenerateRecipe" wx:if="{{isLoggedIn}}">
      {{isLoading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆèœè°±'}}
    </button>
    <button class="btn-primary big" bindtap="onGenerateRecipe" wx:if="{{!isLoggedIn}}">
      ç™»å½•åç”Ÿæˆèœè°±
    </button>
   <!-- <button class="btn-secondary" bindtap="onGoToFoodNutrition">
      ğŸ é£Ÿç‰©è¥å…»
    </button>-->
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{isLoading}}">
    <view class="loading-icon"></view>
    <view class="loading-text">AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆèœè°±...</view>
  </view>

  <!-- æœ€è¿‘ç”Ÿæˆçš„èœè°± -->
  <view class="card" wx:if="{{recentRecipes.length > 0}}">
    <view class="card-title">æœ€è¿‘ç”Ÿæˆ</view>
    <view class="card-content">
      <view 
        wx:for="{{recentRecipes}}" 
        wx:key="index"
        class="recipe-item"
        bindtap="viewRecipe"
        data-recipe="{{item}}"
      >
        <view class="recent-delete" catchtap="deleteRecent" data-index="{{index}}">ğŸ—‘ï¸</view>
        <view class="recipe-info">
          <view class="recipe-name">
            {{item.name}}
            <text class="fav-badge" wx:if="{{item.isFavorited}}">å·²æ”¶è—</text>
          </view>
          <view class="recipe-desc">{{item.description}}</view>
          <view class="recipe-tags">
            <view class="tag" wx:for="{{item.tags}}" wx:key="tagIndex">{{item}}</view>
          </view>
        </view>
        <view class="recipe-arrow">></view>
      </view>
    </view>
  </view>
  </view>
</view> 