<view class="page">
  <!-- 头部标题 -->
  <view class="header">
    <view class="title">健康饮食助手（AI版）</view>
    <view class="subtitle">让AI为您生成美味菜谱</view>
  </view>

  <!-- 顶部标签页 -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 0 ? 'active' : ''}}" bindtap="onTabChange" data-index="0">食材</view>
    <view class="tab-item {{activeTab === 1 ? 'active' : ''}}" bindtap="onTabChange" data-index="1">菜品类型</view>
    <view class="tab-item {{activeTab === 2 ? 'active' : ''}}" bindtap="onTabChange" data-index="2">菜系风格</view>
    <view class="tab-item {{activeTab === 3 ? 'active' : ''}}" bindtap="onTabChange" data-index="3">烹饪方式</view>
  </view>

  <!-- 选择区域卡片 -->
  <view class="card">
    <view class="card-content">
      <!-- 食材多选，横向tab切换大类 -->
      <view wx:if="{{activeTab === 0}}">
        <view class="ingredient-tabs">
          <block wx:for="{{ingredientCategoryTabs}}" wx:key="index">
            <view class="ingredient-tab {{activeIngredientCategoryTab == index ? 'active' : ''}}"
                  data-index="{{index}}"
                  bindtap="onIngredientCategoryTabChange">
              {{item}}
            </view>
          </block>
        </view>
        <view class="category-group">
          <view class="category-title">{{categorizedIngredients[activeIngredientCategoryTab].categoryName}}</view>
          <view class="multi-select-list">
            <block wx:for="{{categorizedIngredients[activeIngredientCategoryTab].ingredients}}" wx:key="name">
              <view class="multi-select-item {{item.selected ? 'selected' : ''}}"
                    bindtap="onIngredientTagTap"
                    data-category-index="{{activeIngredientCategoryTab}}"
                    data-ingredient-index="{{index}}">
                {{item.name}}
              </view>
            </block>
            <view class="add-custom-btn" bindtap="onShowAddCustomInput" data-type="ingredient">+ 新增</view>
          </view>
        </view>
        <!-- 自定义食材输入框弹窗 -->
        <view wx:if="{{showAddCustomInput && addCustomType === 'ingredient'}}" class="add-custom-modal">
          <view class="add-custom-modal-content">
            <input class="add-custom-input" placeholder="请输入自定义食材" value="{{addCustomValue}}" bindinput="onAddCustomInput" />
            <button class="add-custom-confirm" bindtap="onAddCustomConfirm">添加</button>
            <button class="add-custom-cancel" bindtap="onAddCustomCancel">取消</button>
          </view>
        </view>
      </view>
      <!-- 新增：大类单选 -->
      <view wx:if="{{activeTab === 1}}">
        <view class="form-label">选择大类（可不选）</view>
        <view class="single-select-list">
          <block wx:for="{{dishTypeNames}}" wx:key="index">
            <view class="single-select-item {{selectedDishTypeIndex === index ? 'selected' : ''}}"
                  bindtap="onDishTypeTagTap"
                  data-index="{{index}}">
              {{item}}
            </view>
          </block>
          <view class="add-custom-btn" bindtap="onShowAddCustomInput" data-type="dishType">+ 新增</view>
        </view>
        <!-- 自定义类型输入框弹窗 -->
        <view wx:if="{{showAddCustomInput && addCustomType === 'dishType'}}" class="add-custom-modal">
          <view class="add-custom-modal-content">
            <input class="add-custom-input" placeholder="请输入自定义类型" value="{{addCustomValue}}" bindinput="onAddCustomInput" />
            <button class="add-custom-confirm" bindtap="onAddCustomConfirm">添加</button>
            <button class="add-custom-cancel" bindtap="onAddCustomCancel">取消</button>
          </view>
        </view>
      </view>
      <!-- 菜系/种类单选 -->
      <view wx:if="{{activeTab === 2}}">
        <view class="form-label">选择菜系（可不选，默认为家常菜）</view>
        <view class="single-select-list">
          <block wx:for="{{typeNames}}" wx:key="index">
            <view class="single-select-item {{selectedTypeIndex === index ? 'selected' : ''}}"
                  bindtap="onTypeTagTap"
                  data-index="{{index}}">
              {{item}}
            </view>
          </block>
          <view class="add-custom-btn" bindtap="onShowAddCustomInput" data-type="type">+ 新增</view>
        </view>
        <!-- 自定义菜系输入框弹窗 -->
        <view wx:if="{{showAddCustomInput && addCustomType === 'type'}}" class="add-custom-modal">
          <view class="add-custom-modal-content">
            <input class="add-custom-input" placeholder="请输入自定义菜系" value="{{addCustomValue}}" bindinput="onAddCustomInput" />
            <button class="add-custom-confirm" bindtap="onAddCustomConfirm">添加</button>
            <button class="add-custom-cancel" bindtap="onAddCustomCancel">取消</button>
          </view>
        </view>
      </view>
      <!-- 烹饪方式单选 -->
      <view wx:if="{{activeTab === 3}}">
        <view class="form-label">选择烹饪方式（可不选）</view>
        <view class="single-select-list">
          <block wx:for="{{methodNames}}" wx:key="index">
            <view class="single-select-item {{selectedMethodIndex === index ? 'selected' : ''}}"
                  bindtap="onMethodTagTap"
                  data-index="{{index}}">
              {{item}}
            </view>
          </block>
          <view class="add-custom-btn" bindtap="onShowAddCustomInput" data-type="method">+ 新增</view>
        </view>
        <!-- 自定义方式输入框弹窗 -->
        <view wx:if="{{showAddCustomInput && addCustomType === 'method'}}" class="add-custom-modal">
          <view class="add-custom-modal-content">
            <input class="add-custom-input" placeholder="请输入自定义方式" value="{{addCustomValue}}" bindinput="onAddCustomInput" />
            <button class="add-custom-confirm" bindtap="onAddCustomConfirm">添加</button>
            <button class="add-custom-cancel" bindtap="onAddCustomCancel">取消</button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 已选内容展示 -->
  <view wx:if="{{selectedIngredientNames.length > 0 || selectedDishTypeName || selectedTypeName || selectedMethodName}}" class="selected-ingredients-bar">
    <scroll-view scroll-x="true" class="selected-ingredients-list">
      <block wx:if="{{selectedIngredientNames.length > 0}}">
        <view class="selected-ingredients-label">已选食材：</view>
        <block wx:for="{{selectedIngredientNames}}" wx:key="name">
          <view class="selected-ingredient-tag">{{item}}</view>
        </block>
      </block>
      <block wx:if="{{selectedDishTypeName}}">
        <view class="selected-ingredients-label">类型：</view>
        <view class="selected-ingredient-tag">{{selectedDishTypeName}}</view>
      </block>
      <block wx:if="{{selectedTypeName}}">
        <view class="selected-ingredients-label">菜系：</view>
        <view class="selected-ingredient-tag">{{selectedTypeName}}</view>
      </block>
      <block wx:if="{{selectedMethodName}}">
        <view class="selected-ingredients-label">方式：</view>
        <view class="selected-ingredient-tag">{{selectedMethodName}}</view>
      </block>
    </scroll-view>
    <view class="clear-selected-btn" bindtap="onClearAllSelections">🗑️</view>
  </view>

  <!-- 生成按钮 -->
  <view class="generate-btn-wrapper">
    <button class="btn-primary big" bindtap="onGenerateRecipe">生成菜谱</button>
  </view>

  <!-- 加载状态 -->
  <view class="loading" wx:if="{{isLoading}}">
    <view class="loading-icon"></view>
    <view class="loading-text">AI正在为您生成菜谱...</view>
  </view>

  <!-- 最近生成的菜谱 -->
  <view class="card" wx:if="{{recentRecipes.length > 0}}">
    <view class="card-title">最近生成</view>
    <view class="card-content">
      <view 
        wx:for="{{recentRecipes}}" 
        wx:key="index"
        class="recipe-item"
        bindtap="viewRecipe"
        data-recipe="{{item}}"
      >
        <view class="recipe-info">
          <view class="recipe-name">{{item.name}}</view>
          <view class="recipe-desc">{{item.description}}</view>
          <view class="recipe-tags">
            <view class="tag" wx:for="{{item.tags}}" wx:key="tagIndex">{{item}}</view>
          </view>
        </view>
        <view class="recipe-arrow">></view>
      </view>
    </view>
  </view>
</view> 