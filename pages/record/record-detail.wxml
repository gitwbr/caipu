<!--pages/record/record-detail.wxml-->
<view class="container">
  <!-- 日期显示 -->
  <view class="date-display" wx:if="{{recordDate}}">
    <text class="date-text">{{recordDate}}</text>
  </view>

  <!-- 食物信息卡片 -->
  <view class="card food-card" wx:if="{{food}}">
    <view class="card-content">
      <view class="food-header">
        <text class="food-name">{{food.display_name}}</text>
        <view class="food-header-right">
          <text class="food-type">{{food.type === 'standard' ? '标准食物' : food.type === 'custom' ? '自定义食物' : '快速记录'}}</text>
          <text class="edit-icon icon-circle primary" wx:if="{{food.type === 'custom'}}" bindtap="editCustomFood" data-food="{{food}}">✏️</text>
        </view>
      </view>
      <view class="food-nutrition">
        <view class="nutrition-item">
          <text class="nutrition-label">卡路里</text>
          <text class="nutrition-value">{{food.display_energy_kcal}}</text>
          <text class="nutrition-unit">kcal/100g</text>
        </view>
        <view class="nutrition-item" wx:if="{{food.protein_g !== undefined}}">
          <text class="nutrition-label">蛋白质</text>
          <text class="nutrition-value">{{food.protein_g}}</text>
          <text class="nutrition-unit">g/100g</text>
        </view>
        <view class="nutrition-item" wx:if="{{food.fat_g !== undefined}}">
          <text class="nutrition-label">脂肪</text>
          <text class="nutrition-value">{{food.fat_g}}</text>
          <text class="nutrition-unit">g/100g</text>
        </view>
        <view class="nutrition-item" wx:if="{{food.carbohydrate_g !== undefined}}">
          <text class="nutrition-label">碳水化合物</text>
          <text class="nutrition-value">{{food.carbohydrate_g}}</text>
          <text class="nutrition-unit">g/100g</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 输入表单卡片 -->
  <view class="card form-card">
    <view class="card-content">
      <!-- 记录时间 -->
      <view class="form-item">
        <picker mode="time" value="{{recordTime}}" bindchange="onTimeChange">
          <view class="picker-content">
            <text class="picker-value">{{recordTime}}</text>
            <text class="picker-arrow">></text>
          </view>
        </picker>
      </view>

      <!-- 数量输入区域 -->
      <view class="form-item quantity-section" wx:if="{{food.type !== 'quick'}}">
        <view class="quantity-display">
          <text class="quantity-value">{{keypadValue || quantity || '0'}}</text>
          <text class="quantity-unit">克</text>
        </view>
      </view>

      <!-- 备注 -->
      <view class="form-item">
        <textarea 
          class="form-textarea-small" 
          placeholder="可选备注信息" 
          value="{{notes}}"
          bindinput="onNotesInput"
          maxlength="100"
        />
      </view>

      <!-- 自定义数字键盘 -->
      <!-- index.wxml -->
      <view class="keypad" wx:if="{{food.type !== 'quick'}}">
        <!-- 1~9 自动从左到右、从上到下填满前三行的前三列 -->
        <view class="key" data-value="1" bindtap="onKeypadInput">1</view>
        <view class="key" data-value="2" bindtap="onKeypadInput">2</view>
        <view class="key" data-value="3" bindtap="onKeypadInput">3</view>

        <view class="key" data-value="4" bindtap="onKeypadInput">4</view>
        <view class="key" data-value="5" bindtap="onKeypadInput">5</view>
        <view class="key" data-value="6" bindtap="onKeypadInput">6</view>

        <view class="key" data-value="7" bindtap="onKeypadInput">7</view>
        <view class="key" data-value="8" bindtap="onKeypadInput">8</view>
        <view class="key" data-value="9" bindtap="onKeypadInput">9</view>

        <!-- 右侧 x，占 3 行 -->
        <view class="key key-x" data-value="x" bindtap="onKeypadClear">×</view>

        <!-- 第四行：. 0 保存(占两列) -->
        <view class="key key-dot" data-value="." bindtap="onKeypadInput">.</view>
        <view class="key key-zero" data-value="0" bindtap="onKeypadInput">0</view>
        <view class="key key-save" bindtap="saveRecord" bindlongpress="deleteRecord" wx:if="{{isEdit}}">{{isEdit ? '更新' : '保存'}}</view>
        <view class="key key-save" bindtap="saveRecord" wx:else>{{isEdit ? '更新' : '保存'}}</view>
      </view>

      <!-- 计算结果显示 -->
      <view class="calculation-result" wx:if="{{food && calculatedNutrition && (food.type === 'quick' || quantity)}}">
        <view class="calc-header">
          <text class="calc-title">计算结果</text>
        </view>
        <view class="calc-grid">
          <view class="calc-item">
            <text class="calc-label">卡路里</text>
            <text class="calc-value">{{calculatedNutrition.calories}} kcal</text>
          </view>
          <view class="calc-item" wx:if="{{food.protein_g !== undefined}}">
            <text class="calc-label">蛋白质</text>
            <text class="calc-value">{{calculatedNutrition.protein}}g</text>
          </view>
          <view class="calc-item" wx:if="{{food.fat_g !== undefined}}">
            <text class="calc-label">脂肪</text>
            <text class="calc-value">{{calculatedNutrition.fat}}g</text>
          </view>
          <view class="calc-item" wx:if="{{food.carbohydrate_g !== undefined}}">
            <text class="calc-label">碳水化合物</text>
            <text class="calc-value">{{calculatedNutrition.carbohydrate}}g</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading && !food}}">
    <text>加载中...</text>
  </view>
</view>